<html>
    <head>
        {{>html_head_top}}
        <script src="/acorn_interpreter.js"></script>        
        <script>
            var grid=40;
            var maxlevel=10;
            var url = window.location.pathname.split('/');
            var quizID = url[url.length-1];
            window.serialized='';
            window.loadedfromstorage=false
            function joinCollab(){
                var collabGroup=$('#form_collab').val().trim()
                socket.emit('collaborate',collabGroup);
                localStorage.setItem("collaborate_"+quizID, $('#form_collab').val().trim())
            }
            $(document).ready(function() {
                $(document).bind('touchmove', function(e) {
                   e.preventDefault();
                }, false);
                $('#loadLsg').on('click', function(e) {
                   window.serialized=$('#form_reload').val().trim();
                   ParsonAPP.render()
                   ParsonAPP.serializeQuiz()
                });
                $('#collab').on('click', joinCollab);
                $('#leave').on('click', function(e) {
                   $('#form_collab').val("");
                   joinCollab()
                });
                $('#eval').on('click', function(e) {
                    var myInterpreter = new Interpreter("var js_input="+$('#js_input').val()+";"+$('#js_show').val());
                    myInterpreter.run();
                    $('#js_eval').val(myInterpreter.value)
                });
            });
            
            function loadFromStorage() {
                if(!window.loadedfromstorage){
                    if(localStorage.getItem("quizstate_"+quizID)!=undefined){
                        window.serialized=JSON.parse(localStorage.getItem("quizstate_"+quizID))
                        $('#serialized').text(window.serialized)
                    }
                    if(localStorage.getItem("collaborate_"+quizID)!=undefined){
                        $('#form_collab').val(localStorage.getItem("collaborate_"+quizID))
                        joinCollab()
                    }
                }
                window.loadedfromstorage=true;
            }
            socket.on('connect', function(a){
                socket.emit('request',url[url.length-1])
            });
            socket.on('serializationRequest', function(){
                ParsonAPP.serializeQuiz();
            });
            socket.on('serialized', function(a){
                $('#serialized').text(a)
                window.serialized=a
                ParsonAPP.render();
            });
            socket.on('state', function(a){
                loadFromStorage()
                $('.jumbotron > h1').text(a.name)
                $('#description').text(a.description)
                window.parts=a.parts
                window.js_input=a.js_input
                $('#js_input').val(a.js_input)
                window.js_pre=a.js_pre
                window.js_suf=a.js_suf
                ParsonAPP.render()
                ParsonAPP.serializeQuiz()
                ParsonAPP.doNewDraggable();
            });
            
        </script>
        <title>
            Parson
        </title>
    </head>
 
<body>
    {{>fancy_alert}}
    <div class="container">
        <div class="jumbotron">
            <a href="/puzzles">
                Zurück
            </a>
            <h1>
                Parson's Puzzles 
            </h1>
            <p>
                <div id="description"></div>
            </p>
            <hr class="my-4"> 
            <div class="row">
                <div class="card d-block mx-auto">
                    <div class="cardcontainer">
                        <div id="bucket" class="cardd">
                        </div>
                        <div id="warnings">
                        </div>
                        <div id="play" class="cardd card2">
                        </div>
                        <div id="serialized" class="cardd card2">
                        </div>
                        <div id="js_part" class="cardd card2">
                            <div class="form-group">
                                <label for="js_show">Javascript-Code</label>
                                <textarea id="js_show" class="form-control" style="width:100%;height:150px;"></textarea> 
                            </div>
                            <div class="form-inline">
                                <div class="form-group mb-4">
                                    <input type="text" class="form-control" id="js_input" placeholder="Eingabe">
                                </div>
                                <div class="form-group mx-sm-3 mb-4">
                                    <a role="button" class="btn float-right btn-info" id="eval">
                                        Ausführen
                                    </a>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="js_eval">Ausgabe</label>
                                <textarea class="form-control" id="js_eval" style="width:100%;height:150px;"></textarea> 
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <a role="button" class="btn float-right btn-info" href="{{urlprefix}}{{id}}/edit">
                Bearbeiten
            </a>
            <a role="button" class="btn float-right btn-info" href="{{urlprefix}}{{id}}/duplicate">
                Duplizieren
            </a>
<!-- 
            <a role="button" class="btn float-right btn-secondary" href="{{urlprefix}}{{id}}/show">
                Beamer-Modus
            </a>
 -->
            <div class="form-group">
                <label for="form_reload">
                    Bekannte Lösung laden. 
                </label>
                <input type="text" class="form-control" id="form_reload" aria-describedby="reloadHelp" placeholder="Serialisierung eingeben">
                    <small id="reloadHelp" class="form-text text-muted">
                        Einen serialisierten Lösungs-String 
                    </small>
                </div>
                <a role="button" id="loadLsg" class="btn float-right btn-secondary">
                    Laden
                </a>
                <div class="form-group">
                    <label for="form_collab">
                        Collaborate-Gruppe. 
                    </label>
                    <input type="text" class="form-control" id="form_collab" aria-describedby="collabHelp" placeholder="Gruppen-ID">
                        <small id="collabHelp" class="form-text text-muted">
                            Eine Kollaborations-Gruppen-ID angeben 
                        </small>
                    </div>
                    <a role="button" id="leave" class="btn float-right btn-info">
                        Verlassen
                    </a>
                    <a role="button" id="collab" class="btn float-right btn-secondary">
                        Beitreten
                    </a>
                </div>
            </div>
        </div>
    </body>